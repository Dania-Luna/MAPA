<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mapa Interactivo</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <h1>Mapa de Centros de Atención</h1>
    
    <!-- Controles de filtros -->
    <div id="filtros">
        <label for="estado">Filtrar por Estado:</label>
        <select id="estado">
            <option value="todos">Todos</option>
        </select>

        <label for="tipo">Filtrar por Tipo de Unidad:</label>
        <select id="tipo">
            <option value="todos">Todos</option>
        </select>

        <button onclick="filtrarDatos()">Aplicar Filtros</button>
    </div>
    
    <div id="map"></div>
    
    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
    <script>
        function normalizarTexto(texto) {
            return texto
                ? texto.normalize("NFD").replace(/[̀-ͯ]/g, "").toLowerCase().trim()
                : "";
        }

        var map = L.map('map').setView([23.6345, -102.5528], 5);
        var markersLayer = L.layerGroup().addTo(map);
        var estadoLayer = L.layerGroup().addTo(map);

        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; OpenStreetMap contributors'
        }).addTo(map);

        var geojsonData;
        fetch('CENTROS_DE_ATENCION_LIMPIO.geojson')
            .then(response => response.json())
            .then(data => {
                geojsonData = data;
                llenarFiltros(data);
                cargarDatos(data);
            })
            .catch(error => console.error('Error cargando el archivo GeoJSON:', error));

        function cargarDatos(data) {
            markersLayer.clearLayers();
            L.geoJSON(data, {
                pointToLayer: function (feature, latlng) {
                    return L.circleMarker(latlng, {
                        radius: 6,
                        fillColor: "blue",
                        color: "#000",
                        weight: 1,
                        opacity: 1,
                        fillOpacity: 0.8
                    });
                },
                onEachFeature: function (feature, layer) {
                    var estado = normalizarTexto(feature.properties["Estado"]);
                    var municipio = feature.properties["Municipio"]?.trim() || "No disponible";
                    var institucion = feature.properties["Nombre de la institución"]?.trim() || "No disponible";
                    var direccion = feature.properties["Dirección"]?.trim() || "No disponible";
                    var tipo = feature.properties["Tipo"]?.trim() || "No especificado";
                    var horarios = feature.properties["Horarios"]?.trim() || "No disponible";
                    var telefono = feature.properties["Teléfono"]?.trim() || "No disponible";
                    
                    var popupContent = `<b>Estado:</b> ${feature.properties["Estado"]}<br>
                                        <b>Municipio:</b> ${municipio}<br>
                                        <b>Nombre de la institución:</b> ${institucion}<br>
                                        <b>Dirección:</b> ${direccion}<br>
                                        <b>Tipo de Unidad:</b> ${tipo}<br>
                                        <b>Horarios:</b> ${horarios}<br>
                                        <b>Teléfono:</b> ${telefono}`;
                    
                    layer.bindPopup(popupContent);
                    markersLayer.addLayer(layer);
                }
            });
        }

        function llenarFiltros(data) {
            let estados = new Set();
            let tipos = new Set();
            data.features.forEach(feature => {
                if (feature.properties.Estado) estados.add(normalizarTexto(feature.properties.Estado));
                if (feature.properties.Tipo) tipos.add(feature.properties.Tipo.trim());
            });

            let estadoSelect = document.getElementById("estado");
            let tipoSelect = document.getElementById("tipo");

            estados.forEach(estado => {
                let option = document.createElement("option");
                option.value = estado;
                option.textContent = estado.charAt(0).toUpperCase() + estado.slice(1);
                estadoSelect.appendChild(option);
            });

            tipos.forEach(tipo => {
                let option = document.createElement("option");
                option.value = tipo;
                option.textContent = tipo;
                tipoSelect.appendChild(option);
            });
        }

        function filtrarDatos() {
            let estadoSeleccionado = normalizarTexto(document.getElementById("estado").value);
            let tipoSeleccionado = document.getElementById("tipo").value.trim();
            
            let datosFiltrados = {
                type: "FeatureCollection",
                features: geojsonData.features.filter(feature => {
                    let estado = normalizarTexto(feature.properties["Estado"]);
                    let tipo = feature.properties["Tipo"]?.trim() || "";
                    let cumpleEstado = estadoSeleccionado === "todos" || estado === estadoSeleccionado;
                    let cumpleTipo = tipoSeleccionado === "todos" || tipo === tipoSeleccionado;
                    return cumpleEstado && cumpleTipo;
                })
            };
            cargarDatos(datosFiltrados);
        }
    </script>
</body>
</html>
